---
title: 'Generate prediction data'
author: 'Jay Achar'
date: '`r Sys.time()`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
library(forecast)
library(imputeTS)
library(ggExtra)
library(patchwork)
```

```{r load, message=FALSE, warning=FALSE }

const <- constants()

raw <- read_data()
dd <- prepare_data(raw, const = const)
clean <- prepare_long_data(dd, const = const)
```

## Predict 2020 notifications

Predictions should be performed on the most granular data available.
In this analysis, that is country and regional level data by age group and sex.

```{r create-predicted-data }
# create training data
## remove 2020

forecasts <- bind_rows(clean[c("region", "imputed_hbc", "global")],
          .id = "type") %>%
  filter(year != 2020) %>%
  group_by(location, age_group, type, sex) %>%
## nest data by location & age group
  nest() %>%
## create time-series
  mutate(ts = map(data,
                  function(series) {
                    select(series, -year) %>%
                      ts(start = 2014, frequency = 1)
                  })) %>%
  forecast_next_year(order = c(2, 0, 0),
                     drift = TRUE,
                     lambda = NULL,
                     log_transform = TRUE)

```

## Calculate R-squared

Below is the R-squared for the 2019 fit using data including 2014-2019
data points for all HBCs, WHO regions and global values:

```{r}
forecasts$diagnostics <- lapply(
  forecasts$model,
  function(m) {
    observed <-  expm1(m$x)
    fitted <- expm1(m$fitted)
    # residuals <- as.numeric(fitted - observed)
    # ssr <- sum(residuals ^ 2)
    # fitted_mean <- mean(fitted)
    # total_ss <- sum((fitted - fitted_mean) ^ 2)

    return(
      data.frame(
        observed = tail(as.numeric(observed), 1),
        fitted = tail(as.numeric(fitted), 1)
        # ssr = ssr,
        # total_ss = total_ss
        )
      )
  }
)

fitted_df <- reduce(forecasts$diagnostics, bind_rows)

cor(fitted_df$fitted, fitted_df$observed) ^ 2

ggplot(fitted_df, aes(x = observed, y = fitted)) + 
  geom_point() +
  theme_minimal() +
  labs(title = "Observed and fitted values for 2019",
       subtitle = glue::glue("Model trained on 2014-2019 data ({nrow(fitted_df)} data points)"))


ggsave("~/Desktop/covid-children/corr.png",
       width = 10, height = 7, bg = "white")


# forecasts$r_squared <- vapply(forecasts$diagnostics,
#                               function(m) {
#                                 1 - m$ssr / m$total_ss
#                               }, numeric(1))
# 
# p1 <- ggplot(
#   forecasts,
#   aes(y = r_squared,
#       x = 1,
#       color = type)
# ) +
#   geom_jitter(width = 0.25, height = 0, alpha = 0.4) +
#   theme(
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank(),
#     legend.position = "bottom"
#   ) +
#   labs(
#     x = NULL,
#     title = "R-squared for each fitted model"
#   )
# 
# p1 <- ggMarginal(p1, margins = "y",
#            type = "histogram")
# p1

```


```{r extract-predictions}
predictions <- forecasts %>%
  mutate(prediction = map(forecast, function(series) {
    data.frame(
      point = as.integer(series$point),
      lower95 = as.integer(series$lower95),
      upper95 = as.integer(series$upper95)
    )
  })) %>%
  select(type, location, age_group, sex, prediction) %>%
  unnest(cols = c(prediction))

# required for supp table 4
saveRDS(predictions,
        file = paste0(output_dir, "/granular_predictions.rds"))
head(predictions)
```

## Calculate variance

```{r calculate-variance}
granular_predictions <- predictions %>%
  mutate(variance = ((upper95 - lower95) / 3.92) ^ 2) %>%
  select(-lower95, -upper95)

```

## Predictions {.tabset .tabset-pills}

### Main Figure 1

```{r aggregate-age-region}
final_prediction <- list()

final_prediction$age_region <- granular_predictions %>%
  filter(type == "region") %>%
  grouped_predictions(age_group, location)

head(final_prediction$age_region)
```

### Main Figure 2

```{r aggregate-age-hbc}
final_prediction$age_hbc <- granular_predictions %>%
  filter(type == "imputed_hbc") %>%
  grouped_predictions(age_group, location)

head(final_prediction$age_hbc)
```

### Supplement Table 3

Global age and sex uses WHO regional data

```{r aggregate-age-sex}
temp_age_sex <- granular_predictions %>%
  filter(type == "region") %>%
  grouped_predictions(age_group, sex)

final_prediction$age_sex <- granular_predictions %>%
  filter(type == "region") %>%
  grouped_predictions(age_group) %>%
  mutate(sex = "all") %>%
  select(age_group, sex, point, sd) %>%
  bind_rows(temp_age_sex) %>%
  arrange(age_group, desc(sex))

head(final_prediction$age_sex)

```

### Supplement Table 4

Uses the same predictions as Main figure 1

Add global prediction

```{r global-age}
final_prediction$age <- granular_predictions %>%
  filter(type == "region") %>%
  grouped_predictions(age_group)

final_prediction$age
```

### Supplement table 8

```{r}
final_prediction$age_sex_region <- predictions %>% 
  filter(type == "region")

stopifnot(nrow(final_prediction$age_sex_region) == 36)
```




```{r}
# calculate 95% CI
final_prediction <- lapply(final_prediction,
                           FUN = function(x) {
                             if ("lower95" %in% names(x)) {
                               return(x)
                             }
                             
                             x$lower95 = x$point - x$sd * 1.96
                             x$upper95 = x$point + x$sd * 1.96
                             x
                           })


saveRDS(final_prediction,
        file = paste0(output_dir, "/manuscript_predictions.rds"))

```
